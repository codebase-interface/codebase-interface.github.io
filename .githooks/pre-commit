#!/bin/bash
# filepath: /workspaces/codebaseinterface/.githooks/pre-commit

# Pre-commit hook to generate changelog using git-cliff
# This ensures the changelog is updated and included in the current commit

set -e

# Check if git-cliff is available
if ! command -v git-cliff &> /dev/null; then
    echo "Warning: git-cliff not found. Skipping changelog generation."
    exit 0
fi

# Check if cliff.toml exists
if [ ! -f "cliff.toml" ]; then
    echo "Warning: cliff.toml not found. Skipping changelog generation."
    exit 0
fi

echo "Updating changelog with new entries..."

# Check if CHANGELOG.md exists
if [ -f "CHANGELOG.md" ]; then
    # Changelog exists, check if there are unreleased commits to add
    echo "Existing changelog found. Checking for new unreleased entries..."
    
    # Check if there are any unreleased commits
    if git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~999")..HEAD --quiet 2>/dev/null; then
        echo "New commits found. Regenerating full changelog..."
        # Backup existing changelog
        cp CHANGELOG.md CHANGELOG.md.backup
        
        # Generate complete changelog (this handles unreleased + existing properly)
        git-cliff --output CHANGELOG.md
        
        # If generation fails, restore backup
        if [ $? -ne 0 ]; then
            mv CHANGELOG.md.backup CHANGELOG.md
            echo "Failed to generate changelog, restored backup"
        else
            rm -f CHANGELOG.md.backup
        fi
    else
        echo "No new commits to add to changelog."
    fi
else
    # No changelog exists, create it from scratch
    echo "No existing changelog found. Creating new changelog..."
    git-cliff --output CHANGELOG.md
fi

# Check if changelog was modified
if git diff --quiet CHANGELOG.md; then
    echo "Changelog is up to date."
else
    echo "Changelog updated. Adding to commit..."
    # Stage the updated changelog
    git add CHANGELOG.md
    echo "Changelog has been updated and staged for this commit."
fi

exit 0